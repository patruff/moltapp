---
phase: 09-ongoing-improvement
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/routes/pages.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /economics page"
    - "User can see total LLM spend in USD"
    - "User can see total trading P&L"
    - "User can see net economics (P&L minus cost)"
    - "User can see per-agent cost breakdown"
  artifacts:
    - path: "src/routes/pages.tsx"
      provides: "/economics route with cost vs return dashboard"
      contains: 'pages.get.*economics'
  key_links:
    - from: "src/routes/pages.tsx"
      to: "src/services/llm-cost-tracker.ts"
      via: "getTotalCosts import and call"
      pattern: "getTotalCosts"
    - from: "src/routes/pages.tsx"
      to: "getLeaderboard"
      via: "existing leaderboard query for P&L"
      pattern: "getLeaderboard"
---

<objective>
Create an /economics dashboard page showing LLM cost vs trading returns.

Purpose: Answer "Are the agents actually making money?" by showing cost vs return in a single view. This is the user-facing output of the cost tracking work.

Output:
- New `/economics` route in pages.tsx
- Dashboard showing total costs, total P&L, net economics, per-agent breakdown
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-ongoing-improvement/09-RESEARCH.md
@.planning/phases/09-ongoing-improvement/09-01-SUMMARY.md

# Key files
@src/routes/pages.tsx
@src/services/llm-cost-tracker.ts
@src/services/leaderboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Economics Dashboard Route</name>
  <files>src/routes/pages.tsx</files>
  <action>
1. Add import at top of file (around line 11):
```typescript
import { getTotalCosts } from "../services/llm-cost-tracker.ts";
```

2. Add link to /economics on homepage header (around line 132, near the "View Rounds Timeline" link):
```typescript
<a href="/economics" class="text-sm text-blue-400 hover:text-blue-300">
  View Economics Dashboard &rarr;
</a>
```

3. Add new route before the export (at end of file, before `export { pages }`):
```typescript
// ---------------------------------------------------------------------------
// Economics Dashboard - Cost vs Return Analysis
// ---------------------------------------------------------------------------

pages.get("/economics", async (c) => {
  // Get LLM costs
  const costs = await getTotalCosts();

  // Get P&L from leaderboard
  const leaderboard = await getLeaderboard();
  const totalPnl = leaderboard.reduce((sum, agent) => sum + parseFloat(agent.totalPnlPercent), 0);
  const totalPnlUsd = leaderboard.reduce((sum, agent) => {
    const pnlPercent = parseFloat(agent.totalPnlPercent);
    const totalValue = parseFloat(agent.totalValue);
    // Approximate USD P&L: totalValue * pnlPercent / (100 + pnlPercent)
    const initialValue = totalValue / (1 + pnlPercent / 100);
    return sum + (totalValue - initialValue);
  }, 0);

  // Calculate net economics
  const netEconomics = totalPnlUsd - costs.totalCost;
  const isProfit = netEconomics > 0;

  // Map agent costs to leaderboard entries
  const agentEconomics = leaderboard.map((agent) => {
    const agentCost = costs.byAgent.find((c) => c.agentId === agent.agentId);
    const pnlPercent = parseFloat(agent.totalPnlPercent);
    const totalValue = parseFloat(agent.totalValue);
    const initialValue = totalValue / (1 + pnlPercent / 100);
    const pnlUsd = totalValue - initialValue;

    return {
      agentId: agent.agentId,
      name: agent.agentName,
      model: agent.model ?? "unknown",
      cost: agentCost?.cost ?? 0,
      tokens: agentCost?.tokens ?? 0,
      pnlPercent,
      pnlUsd,
      netEconomics: pnlUsd - (agentCost?.cost ?? 0),
    };
  });

  return c.render(
    <div class="max-w-6xl mx-auto px-4 py-8">
      {/* Header */}
      <div class="mb-8">
        <a href="/" class="text-blue-400 hover:text-blue-300 text-sm mb-2 inline-block">
          &larr; Back to Leaderboard
        </a>
        <h1 class="text-3xl font-bold text-white mb-2">Economics Dashboard</h1>
        <p class="text-gray-400">Are the agents actually making money? Cost vs Return analysis.</p>
      </div>

      {/* Summary Cards */}
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        {/* Total LLM Cost */}
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm mb-1">Total LLM Cost</div>
          <div class="text-2xl font-bold text-red-400">
            ${costs.totalCost.toFixed(4)}
          </div>
          <div class="text-gray-500 text-xs mt-1">
            {costs.totalTokens.toLocaleString()} tokens
          </div>
        </div>

        {/* Total Trading P&L */}
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm mb-1">Total Trading P&L</div>
          <div class={`text-2xl font-bold ${totalPnlUsd >= 0 ? "text-green-400" : "text-red-400"}`}>
            {totalPnlUsd >= 0 ? "+" : ""}${totalPnlUsd.toFixed(2)}
          </div>
          <div class="text-gray-500 text-xs mt-1">
            {totalPnl >= 0 ? "+" : ""}{totalPnl.toFixed(2)}% combined
          </div>
        </div>

        {/* Net Economics */}
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm mb-1">Net Economics</div>
          <div class={`text-2xl font-bold ${isProfit ? "text-green-400" : "text-red-400"}`}>
            {isProfit ? "+" : ""}${netEconomics.toFixed(2)}
          </div>
          <div class="text-gray-500 text-xs mt-1">
            P&L minus LLM costs
          </div>
        </div>

        {/* ROI on LLM Spend */}
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
          <div class="text-gray-400 text-sm mb-1">ROI on LLM Spend</div>
          <div class={`text-2xl font-bold ${isProfit ? "text-green-400" : "text-red-400"}`}>
            {costs.totalCost > 0 ? ((totalPnlUsd / costs.totalCost) * 100).toFixed(0) : 0}%
          </div>
          <div class="text-gray-500 text-xs mt-1">
            P&L / Cost ratio
          </div>
        </div>
      </div>

      {/* Per-Agent Breakdown */}
      <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-800">
          <h2 class="text-lg font-semibold text-white">Per-Agent Economics</h2>
        </div>
        <table class="w-full">
          <thead class="bg-gray-800/50">
            <tr>
              <th class="px-4 py-2 text-left text-gray-400 text-sm font-medium">Agent</th>
              <th class="px-4 py-2 text-left text-gray-400 text-sm font-medium">Model</th>
              <th class="px-4 py-2 text-right text-gray-400 text-sm font-medium">LLM Cost</th>
              <th class="px-4 py-2 text-right text-gray-400 text-sm font-medium">Tokens</th>
              <th class="px-4 py-2 text-right text-gray-400 text-sm font-medium">Trading P&L</th>
              <th class="px-4 py-2 text-right text-gray-400 text-sm font-medium">Net</th>
            </tr>
          </thead>
          <tbody>
            {agentEconomics.map((agent, i) => (
              <tr class={i % 2 === 0 ? "bg-gray-900" : "bg-gray-900/50"}>
                <td class="px-4 py-3 text-white font-medium">
                  <a href={`/agent/${agent.agentId}`} class="hover:text-blue-400">
                    {agent.name}
                  </a>
                </td>
                <td class="px-4 py-3 text-gray-400 text-sm">{agent.model}</td>
                <td class="px-4 py-3 text-right text-red-400">
                  ${agent.cost.toFixed(4)}
                </td>
                <td class="px-4 py-3 text-right text-gray-400">
                  {agent.tokens.toLocaleString()}
                </td>
                <td class={`px-4 py-3 text-right ${agent.pnlUsd >= 0 ? "text-green-400" : "text-red-400"}`}>
                  {agent.pnlUsd >= 0 ? "+" : ""}${agent.pnlUsd.toFixed(2)}
                  <span class="text-gray-500 text-xs ml-1">
                    ({agent.pnlPercent >= 0 ? "+" : ""}{agent.pnlPercent.toFixed(1)}%)
                  </span>
                </td>
                <td class={`px-4 py-3 text-right font-bold ${agent.netEconomics >= 0 ? "text-green-400" : "text-red-400"}`}>
                  {agent.netEconomics >= 0 ? "+" : ""}${agent.netEconomics.toFixed(2)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Explanation */}
      <div class="mt-8 bg-gray-900/50 border border-gray-800 rounded-lg p-4">
        <h3 class="text-white font-semibold mb-2">How is this calculated?</h3>
        <ul class="text-gray-400 text-sm space-y-1">
          <li><span class="text-red-400">LLM Cost</span> = Token usage x Model pricing (tracked since cost tracking enabled)</li>
          <li><span class="text-green-400">Trading P&L</span> = Current portfolio value - Initial deposit value</li>
          <li><span class="text-blue-400">Net Economics</span> = Trading P&L - LLM Cost (positive = profitable benchmark)</li>
          <li><span class="text-yellow-400">ROI</span> = (Trading P&L / LLM Cost) x 100% (how much return per dollar spent on AI)</li>
        </ul>
        <p class="text-gray-500 text-xs mt-3">
          Note: LLM costs only include rounds after cost tracking was enabled. Historical rounds before this feature are not included.
        </p>
      </div>
    </div>,
    { title: "Economics Dashboard - MoltApp" }
  );
});
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Visit `/economics` in browser to verify page renders with cost data.
  </verify>
  <done>
- /economics route exists and renders
- Shows total LLM cost, total P&L, net economics, ROI
- Shows per-agent breakdown with cost, tokens, P&L, net
- Link to /economics appears on homepage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Economics Summary to Agent Profile</name>
  <files>src/routes/pages.tsx</files>
  <action>
In the agent profile page (`/agent/:id` route, around line 300-500), add a small economics card showing that agent's LLM spend:

1. Add import for getAgentCosts (already imported getTotalCosts, add getAgentCosts):
```typescript
import { getTotalCosts, getAgentCosts } from "../services/llm-cost-tracker.ts";
```

2. In the `/agent/:id` route handler, fetch agent costs:
```typescript
// After fetching other data (wallet, portfolio, trades, theses)
const agentCosts = await getAgentCosts(agentId);
```

3. Add an economics summary card in the agent profile (after the portfolio summary, before positions):
```typescript
{/* LLM Economics */}
{agentCosts.totalTokens > 0 && (
  <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-6">
    <h3 class="text-white font-semibold mb-3">LLM Economics</h3>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <div class="text-gray-400 text-sm">Total LLM Cost</div>
        <div class="text-red-400 font-bold">${agentCosts.totalCost.toFixed(4)}</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Total Tokens</div>
        <div class="text-gray-300">{agentCosts.totalTokens.toLocaleString()}</div>
      </div>
    </div>
    <a href="/economics" class="text-blue-400 hover:text-blue-300 text-sm mt-2 inline-block">
      View full economics &rarr;
    </a>
  </div>
)}
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Visit `/agent/{agentId}` to verify economics card appears when agent has usage data.
  </verify>
  <done>
- Agent profile shows LLM cost and token count
- Links to /economics for full breakdown
- Only shows if agent has recorded usage
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 new errors
2. `/economics` route exists and is accessible
3. Dashboard shows total LLM cost, total P&L, net economics, ROI
4. Per-agent breakdown table shows cost, tokens, P&L, net per agent
5. Homepage has link to /economics
6. Agent profile pages show LLM economics card (when data exists)
</verification>

<success_criteria>
- User can navigate to /economics and see cost vs return dashboard
- Dashboard answers "Are agents making money?" with clear numbers
- Per-agent breakdown shows which agents are economically viable
- Agent profiles include economics summary
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-ongoing-improvement/09-02-SUMMARY.md`
</output>

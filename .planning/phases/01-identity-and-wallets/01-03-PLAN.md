---
phase: 01-identity-and-wallets
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/services/withdrawal.ts
  - src/routes/wallets.ts
autonomous: true

must_haves:
  truths:
    - "Agent can withdraw SOL to an external Solana address via POST /api/v1/wallet/withdraw"
    - "Agent can withdraw USDC to an external Solana address via POST /api/v1/wallet/withdraw"
    - "Withdrawal is rejected if insufficient balance for amount + transaction fee"
    - "Withdrawal transaction is recorded in the transactions table"
  artifacts:
    - path: "src/services/withdrawal.ts"
      provides: "SOL and USDC withdrawal transaction construction and signing"
      contains: "withdrawSOL"
    - path: "src/routes/wallets.ts"
      provides: "POST /withdraw endpoint"
      contains: "withdraw"
  key_links:
    - from: "src/routes/wallets.ts"
      to: "src/services/withdrawal.ts"
      via: "calls withdrawSOL or withdrawUSDC based on tokenType"
      pattern: "withdraw(SOL|USDC)"
    - from: "src/services/withdrawal.ts"
      to: "src/services/wallet.ts"
      via: "uses TurnkeySigner to sign withdrawal transactions"
      pattern: "turnkeySigner"
    - from: "src/services/withdrawal.ts"
      to: "@solana/kit"
      via: "constructs and submits Solana transactions"
      pattern: "sendTransaction|getTransferSolInstruction"
    - from: "src/routes/wallets.ts"
      to: "src/db/schema/transactions.ts"
      via: "records withdrawal in transactions table"
      pattern: "transactions"
---

<objective>
Implement SOL and USDC withdrawal from agent wallets to external Solana addresses. Construct transactions with @solana/kit, sign with Turnkey, submit to Solana, and record in the transaction log.

Purpose: Withdrawal completes the wallet lifecycle. Without it, agents can fund wallets but cannot move funds out -- a critical capability for any financial platform.

Output: POST /api/v1/wallet/withdraw endpoint supporting SOL and USDC withdrawals, with balance validation, Turnkey signing, and transaction recording.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-identity-and-wallets/01-RESEARCH.md
@.planning/phases/01-identity-and-wallets/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Withdrawal service for SOL and USDC transfers</name>
  <files>
    src/services/withdrawal.ts
  </files>
  <action>
    Create src/services/withdrawal.ts with two exported functions:

    1. `withdrawSOL(params: { agentWalletAddress: string, destinationAddress: string, amountLamports: bigint }): Promise<{ txSignature: string }>`:
       a. Get latest blockhash from RPC: `rpc.getLatestBlockhash().send()`
       b. Build transfer instruction using `getTransferSolInstruction` from `@solana-program/system`:
          ```
          getTransferSolInstruction({
            source: address(agentWalletAddress),
            destination: address(destinationAddress),
            amount: lamports(amountLamports),
          })
          ```
       c. Build transaction message using @solana/kit pipe pattern:
          ```
          pipe(
            createTransactionMessage({ version: 0 }),
            (msg) => setTransactionMessageLifetimeUsingBlockhash(latestBlockhash, msg),
            (msg) => appendTransactionMessageInstructions([transferInstruction], msg),
          )
          ```
       d. Sign with Turnkey signer: `getTurnkeySigner().signTransaction(transactionMessage, agentWalletAddress)`
       e. Submit to Solana: `rpc.sendTransaction(signedTransaction).send()`
       f. Return `{ txSignature }`

    2. `withdrawUSDC(params: { agentWalletAddress: string, destinationAddress: string, amount: bigint }): Promise<{ txSignature: string }>`:
       a. Get latest blockhash
       b. Derive source ATA (agent's USDC token account) and destination ATA
       c. Build token transfer instruction using `@solana/spl-token` `createTransferInstruction`:
          - Source: agent's USDC ATA
          - Destination: recipient's USDC ATA
          - Owner: agent wallet address (Turnkey-managed)
          - Amount: in smallest USDC units (6 decimals)
       d. If destination ATA might not exist, include a `createAssociatedTokenAccountInstruction` before the transfer (pay from agent wallet). This handles first-time USDC recipients.
       e. Sign with Turnkey signer
       f. Submit to Solana
       g. Return `{ txSignature }`

    3. `estimateWithdrawalFee(tokenType: 'SOL' | 'USDC'): bigint`:
       - SOL transfer: ~5000 lamports (0.000005 SOL)
       - USDC transfer: ~10000 lamports (higher due to token program instructions + potential ATA creation ~2_039_280 lamports if ATA doesn't exist)
       - Return conservative estimates

    Important notes:
    - Import `getTurnkeySigner` from `src/services/wallet.ts` (created in Plan 02)
    - Import RPC client setup from a shared location or create inline (use env.SOLANA_RPC_URL)
    - The @turnkey/solana `TurnkeySigner` may need `@solana/compat` bridge if it doesn't support @solana/kit types directly. If the Turnkey signer expects legacy web3.js types, use `@solana/compat` to convert. Install it if needed: `npm install @solana/compat`
    - Use `decimal.js` for any amount calculations
    - All amounts should be handled as BigInt (lamports for SOL, smallest units for USDC)
    - Wrap all Solana RPC and Turnkey calls in try/catch with descriptive error messages
  </action>
  <verify>
    1. `npm run build` compiles without errors
    2. `withdrawSOL` function exists and accepts the correct parameters
    3. `withdrawUSDC` function exists and accepts the correct parameters
    4. Both functions use Turnkey signer (not raw keypairs)
  </verify>
  <done>
    Withdrawal service can construct, sign (via Turnkey), and submit both SOL and USDC transfer transactions to Solana.
  </done>
</task>

<task type="auto">
  <name>Task 2: Withdrawal endpoint with balance validation and transaction recording</name>
  <files>
    src/routes/wallets.ts
  </files>
  <action>
    Add POST /withdraw to the existing walletRoutes in src/routes/wallets.ts:

    1. Request validation with Zod:
       ```
       {
         tokenType: z.enum(['SOL', 'USDC']),
         amount: z.string().regex(/^\d+(\.\d+)?$/, 'Must be a valid decimal number'),
         destinationAddress: z.string().min(32).max(44)
       }
       ```
       - `amount` is in human-readable units (e.g., "1.5" SOL or "100.00" USDC)

    2. Get agent's wallet from DB (using agentId from auth middleware)

    3. Convert amount to smallest units using decimal.js:
       - SOL: multiply by 1e9 to get lamports
       - USDC: multiply by 1e6 to get raw amount

    4. Balance check:
       a. Query on-chain balance (same logic as GET /balance endpoint)
       b. Estimate fee using `estimateWithdrawalFee(tokenType)`
       c. For SOL: check that current SOL balance >= amount + fee
       d. For USDC: check that USDC balance >= amount AND SOL balance >= fee (SOL needed for tx fee)
       e. If insufficient, return 400:
          ```json
          {
            "error": "insufficient_balance",
            "details": {
              "requested": "1.500000000",
              "available": "1.000000000",
              "estimatedFee": "0.000005000",
              "tokenType": "SOL"
            }
          }
          ```

    5. Execute withdrawal:
       - Call `withdrawSOL` or `withdrawUSDC` from withdrawal service based on tokenType
       - If transaction fails, return 500 `{ error: "withdrawal_failed", details: errorMessage }`

    6. Record transaction:
       - Insert into transactions table: agentId, type='withdrawal', tokenType, amount (in decimal), txSignature, status='confirmed', destinationAddress, createdAt, confirmedAt
       - Use the txSignature from the withdrawal response

    7. Return 200:
       ```json
       {
         "txSignature": "5Uh8...",
         "tokenType": "SOL",
         "amount": "1.500000000",
         "destinationAddress": "7xKX...",
         "status": "confirmed"
       }
       ```

    Important notes:
    - Validate the destination address is a valid Solana base58 address. Use a try/catch around `address(destinationAddress)` from @solana/kit -- if it throws, the address is invalid.
    - Do NOT allow withdrawals to the agent's own wallet address (pointless and wastes fees)
    - Log all withdrawal attempts (success and failure) for audit trail
  </action>
  <verify>
    1. `npm run build` compiles without errors
    2. POST /api/v1/wallet/withdraw without auth returns 401
    3. POST /api/v1/wallet/withdraw with auth but invalid body returns 400 validation error
    4. POST /api/v1/wallet/withdraw with valid params but insufficient balance returns 400 with details
    5. On devnet with funded wallet: POST /api/v1/wallet/withdraw with valid SOL amount succeeds and returns txSignature
  </verify>
  <done>
    Withdrawal endpoint validates balance, constructs transactions, signs via Turnkey, submits to Solana, and records in DB. WALL-04 (withdrawal) is complete. All 8 Phase 1 requirements (AUTH-01 through AUTH-04, WALL-01 through WALL-04) are now implemented.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors (`npm run build`)
- POST /api/v1/wallet/withdraw rejects unauthenticated requests
- POST /api/v1/wallet/withdraw validates request body (tokenType, amount, destinationAddress)
- POST /api/v1/wallet/withdraw rejects insufficient balance with detailed error
- POST /api/v1/wallet/withdraw successfully submits SOL transfer on devnet
- Transaction record appears in transactions table after withdrawal
- Complete Phase 1 flow works: register -> get wallet -> fund (via deposit) -> check balance -> withdraw
</verification>

<success_criteria>
1. SOL withdrawal works end-to-end on devnet (construct -> sign -> submit -> record)
2. USDC withdrawal works end-to-end on devnet
3. Insufficient balance returns clear 400 error with available vs requested amounts
4. Invalid destination address is rejected
5. Transaction is recorded in DB with correct details
6. All 8 Phase 1 requirements are satisfied: AUTH-01, AUTH-02, AUTH-03, AUTH-04, WALL-01, WALL-02, WALL-03, WALL-04
</success_criteria>

<output>
After completion, create `.planning/phases/01-identity-and-wallets/01-03-SUMMARY.md`
</output>

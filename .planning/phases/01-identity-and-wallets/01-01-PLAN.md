---
phase: 01-identity-and-wallets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - drizzle.config.ts
  - src/index.ts
  - src/config/env.ts
  - src/config/constants.ts
  - src/db/index.ts
  - src/db/schema/agents.ts
  - src/db/schema/wallets.ts
  - src/db/schema/api-keys.ts
  - src/db/schema/transactions.ts
  - src/db/schema/index.ts
  - src/services/moltbook.ts
  - src/routes/auth.ts
  - src/middleware/auth.ts
  - src/middleware/rate-limit.ts
  - .env.example
  - .gitignore
autonomous: true
user_setup:
  - service: moltbook
    why: "Moltbook identity verification for agent auth"
    env_vars:
      - name: MOLTBOOK_APP_KEY
        source: "Moltbook developer portal -- obtain app API key for X-Moltbook-App-Key header"
  - service: postgresql
    why: "Agent profiles, wallet records, API keys, transaction log"
    env_vars:
      - name: DATABASE_URL
        source: "Local PostgreSQL or hosted provider (e.g., Neon, Supabase, Railway)"

must_haves:
  truths:
    - "Agent can POST an identity token to /api/v1/auth/register and receive an API key"
    - "Agent profile (name, karma, avatar) is persisted in the database after registration"
    - "API requests without a valid API key are rejected with 401"
    - "API requests exceeding rate limit are rejected with 429"
  artifacts:
    - path: "src/index.ts"
      provides: "Hono app entry point with route mounting"
      contains: "serve"
    - path: "src/db/schema/agents.ts"
      provides: "Agent profiles table"
      contains: "pgTable"
    - path: "src/db/schema/api-keys.ts"
      provides: "API key records table"
      contains: "keyHash"
    - path: "src/services/moltbook.ts"
      provides: "Moltbook identity verification client"
      contains: "verify-identity"
    - path: "src/routes/auth.ts"
      provides: "Registration endpoint"
      exports: ["authRoutes"]
    - path: "src/middleware/auth.ts"
      provides: "API key verification middleware"
      contains: "Bearer"
    - path: "src/middleware/rate-limit.ts"
      provides: "Per-agent rate limiting"
      contains: "rateLimiter"
  key_links:
    - from: "src/routes/auth.ts"
      to: "src/services/moltbook.ts"
      via: "calls verifyIdentity during registration"
      pattern: "verifyIdentity"
    - from: "src/routes/auth.ts"
      to: "src/db/schema/agents.ts"
      via: "upserts agent profile after Moltbook verification"
      pattern: "agents"
    - from: "src/middleware/auth.ts"
      to: "src/db/schema/api-keys.ts"
      via: "looks up hashed API key in database"
      pattern: "keyHash"
    - from: "src/index.ts"
      to: "src/middleware/rate-limit.ts"
      via: "applies rate limiter to /api/v1/* routes"
      pattern: "rateLimiter"
---

<objective>
Set up the MoltApp project from scratch and implement the complete authentication flow: Moltbook identity verification, agent profile caching, API key issuance, auth middleware, and per-agent rate limiting.

Purpose: This is the foundation for everything in MoltApp. No wallet, trading, or dashboard feature works without agents being able to authenticate and receive API keys. Auth is the gateway.

Output: A working Hono API server with a PostgreSQL database, a /api/v1/auth/register endpoint that verifies Moltbook identity tokens and issues API keys, auth middleware that validates API keys on protected routes, and per-agent rate limiting.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-identity-and-wallets/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold, database schema, and config</name>
  <files>
    package.json
    tsconfig.json
    drizzle.config.ts
    src/index.ts
    src/config/env.ts
    src/config/constants.ts
    src/db/index.ts
    src/db/schema/agents.ts
    src/db/schema/wallets.ts
    src/db/schema/api-keys.ts
    src/db/schema/transactions.ts
    src/db/schema/index.ts
    .env.example
    .gitignore
  </files>
  <action>
    1. Initialize the Node.js project and install dependencies:
       ```
       npm init -y
       npm install hono @hono/node-server zod jose drizzle-orm pg hono-rate-limiter decimal.js
       npm install -D typescript @types/node @types/pg tsx vitest drizzle-kit
       ```
       Note: Do NOT install Turnkey or Solana packages yet -- that is Plan 02.

    2. Create tsconfig.json targeting ES2022, module NodeNext, strict mode, outDir "dist", rootDir "src".

    3. Create src/config/env.ts:
       - Use Zod to validate all environment variables at startup
       - Required vars: DATABASE_URL, MOLTBOOK_APP_KEY, PORT (default 3000), NODE_ENV (default "development")
       - Future vars (optional for now): TURNKEY_API_PRIVATE_KEY, TURNKEY_API_PUBLIC_KEY, TURNKEY_ORGANIZATION_ID, SOLANA_RPC_URL, HELIUS_API_KEY, HELIUS_WEBHOOK_SECRET, APP_URL
       - Export a typed `env` object. Crash on startup if required vars missing.

    4. Create src/config/constants.ts:
       - USDC_MINT_MAINNET = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
       - USDC_MINT_DEVNET = "4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU"
       - API key prefix: "mk_" (for "molt key")
       - Rate limit: 60 requests per minute per agent

    5. Create Drizzle schema files following the RESEARCH.md schema exactly:
       - src/db/schema/agents.ts: agents table (id text PK, name, description, karma, avatarUrl, ownerXHandle, ownerXName, isActive, createdAt, updatedAt)
       - src/db/schema/wallets.ts: wallets table (id serial PK, agentId FK unique, publicKey unique, turnkeyWalletId, usdcAtaAddress, createdAt)
       - src/db/schema/api-keys.ts: apiKeys table (id serial PK, agentId FK, keyHash unique, keyPrefix, isRevoked, lastUsedAt, createdAt)
       - src/db/schema/transactions.ts: transactions table (id serial PK, agentId FK, type, tokenType, amount numeric(20,9), txSignature unique, status, destinationAddress, createdAt, confirmedAt)
       - src/db/schema/index.ts: re-export all tables
       - Use `generatedAlwaysAsIdentity()` for serial IDs (not autoincrement).

    6. Create src/db/index.ts:
       - Initialize Drizzle with the `pg` driver using DATABASE_URL from env
       - Export the `db` instance and `pool` (for graceful shutdown)

    7. Create drizzle.config.ts pointing to src/db/schema for schema and src/db/migrations for output.

    8. Create src/index.ts:
       - Minimal Hono app with `@hono/node-server` serve()
       - Mount a health check at GET /health returning { status: "ok" }
       - Import env config (triggers validation at startup)
       - Listen on env.PORT
       - Log "MoltApp API listening on port {PORT}" at startup

    9. Create .env.example with all env vars (empty values) and comments.

    10. Create .gitignore: node_modules, dist, .env, *.log

    11. Add scripts to package.json:
        - "dev": "tsx watch src/index.ts"
        - "build": "tsc"
        - "start": "node dist/index.js"
        - "db:generate": "drizzle-kit generate"
        - "db:migrate": "drizzle-kit migrate"
        - "test": "vitest run"
  </action>
  <verify>
    1. `npm run build` completes without TypeScript errors
    2. `npx tsx src/config/env.ts` with required env vars set prints no errors
    3. `npx drizzle-kit generate` produces migration SQL files in src/db/migrations/
  </verify>
  <done>
    Project compiles, Drizzle generates migrations from schema, env validation works, all 4 schema tables defined with correct columns and constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Moltbook auth service, registration endpoint, API key middleware, and rate limiting</name>
  <files>
    src/services/moltbook.ts
    src/routes/auth.ts
    src/middleware/auth.ts
    src/middleware/rate-limit.ts
    src/index.ts
  </files>
  <action>
    1. Create src/services/moltbook.ts:
       - Export `verifyIdentity(identityToken: string): Promise<MoltbookAgent>` function
       - POST to `https://moltbook.com/api/v1/agents/verify-identity` with:
         - Header `X-Moltbook-App-Key: env.MOLTBOOK_APP_KEY`
         - Header `Content-Type: application/json`
         - Body: `{ token: identityToken, audience: "moltapp.com" }`
       - On success (200), return the `agent` object from the response
       - On 401, throw an error with message "invalid_identity_token"
       - On 429, throw an error with message "moltbook_rate_limited"
       - On other errors, throw with message "moltbook_verification_failed"
       - Define and export the `MoltbookAgent` type matching the Moltbook response shape:
         ```
         { id, name, description, karma, avatar_url, created_at, is_claimed,
           follower_count, following_count, stats: { posts, comments },
           owner: { x_handle, x_name, x_avatar, x_verified, x_follower_count } }
         ```

    2. Create src/routes/auth.ts:
       - Create a Hono sub-app: `const authRoutes = new Hono()`
       - POST /register endpoint:
         a. Parse body with Zod: `{ identityToken: z.string().min(1) }`
         b. Call `verifyIdentity(identityToken)` -- on failure, return 401 with error
         c. Upsert agent into `agents` table (insert on conflict update name, karma, avatarUrl, ownerXHandle, ownerXName, updatedAt)
         d. Generate API key: `crypto.randomBytes(32).toString('hex')`, prefix with "mk_"
         e. Hash the full key with SHA-256
         f. Insert into `apiKeys` table: agentId, keyHash, keyPrefix (first 12 chars of full key)
         g. Return 200: `{ agentId, apiKey, profile: { name, karma, avatarUrl } }`
       - If agent already has a non-revoked API key, revoke the old one before issuing new one (simple key rotation)
       - Export `authRoutes`

    3. Create src/middleware/auth.ts:
       - Export `authMiddleware` using `createMiddleware` from `hono/factory`
       - Extract Bearer token from Authorization header
       - If missing, return 401 `{ error: "missing_api_key" }`
       - SHA-256 hash the token
       - Query `apiKeys` table where keyHash matches AND isRevoked is false
       - If no match, return 401 `{ error: "invalid_api_key" }`
       - Set `c.set('agentId', record.agentId)` for downstream handlers
       - Fire-and-forget update `lastUsedAt` timestamp
       - Call `await next()`

    4. Create src/middleware/rate-limit.ts:
       - Import `rateLimiter` from `hono-rate-limiter`
       - Configure: windowMs = 60_000 (1 minute), limit = 60
       - keyGenerator: `(c) => c.get('agentId') || 'anonymous'`
       - Export `agentRateLimiter`
       - Note: rate limiter must be applied AFTER auth middleware (so agentId is available)

    5. Update src/index.ts:
       - Import and mount authRoutes at `/api/v1/auth`
       - Apply authMiddleware + agentRateLimiter to `/api/v1/*` routes EXCEPT `/api/v1/auth/register` (registration is unauthenticated)
       - Pattern: create a protected sub-app with auth + rate limiting, mount auth routes separately
       - Add a placeholder GET /api/v1/me endpoint (behind auth) that returns `{ agentId: c.get('agentId') }` for testing auth middleware

    Important: Use `eq` from `drizzle-orm` for query conditions. Import schema tables from `src/db/schema/index.ts`. Use `createHash` from Node.js `crypto` module for SHA-256 hashing.
  </action>
  <verify>
    1. `npm run build` compiles without errors
    2. Start the server with `npm run dev` (requires DATABASE_URL and MOLTBOOK_APP_KEY env vars)
    3. `curl -X POST http://localhost:3000/api/v1/auth/register -H "Content-Type: application/json" -d '{"identityToken":"test"}'` returns 401 (Moltbook rejects invalid token) -- confirms the flow works end-to-end
    4. `curl http://localhost:3000/api/v1/me` returns 401 `{"error":"missing_api_key"}` -- confirms auth middleware works
    5. `curl http://localhost:3000/health` returns 200 `{"status":"ok"}`
  </verify>
  <done>
    Registration endpoint accepts Moltbook identity tokens and returns API keys. Auth middleware protects routes. Rate limiter rejects excessive requests per agent. Agent profiles are cached in the database. All four AUTH requirements (AUTH-01 through AUTH-04) are implemented.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors (`npm run build`)
- Drizzle generates migrations from schema (`npx drizzle-kit generate`)
- Health check responds at GET /health
- Registration endpoint rejects invalid tokens with 401
- Auth middleware rejects unauthenticated requests with 401
- Rate limiter returns 429 when limit exceeded
- Database has agents, wallets, apiKeys, transactions tables after migration
</verification>

<success_criteria>
1. `npm run build` passes with zero errors
2. Server starts and responds to health check
3. POST /api/v1/auth/register with invalid token returns 401 (proves Moltbook integration wired)
4. GET /api/v1/me without API key returns 401 (proves auth middleware works)
5. GET /api/v1/me with valid API key returns 200 with agentId (proves full auth flow)
6. Database schema has all 4 tables with correct columns
</success_criteria>

<output>
After completion, create `.planning/phases/01-identity-and-wallets/01-01-SUMMARY.md`
</output>

---
phase: 10-agent-decision-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/tool-use-quality-analyzer.ts
  - src/db/schema/decision-quality.ts
  - src/db/schema/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool use quality can be analyzed for any agent"
    - "Tool sequence violations are detected and categorized"
    - "Quality snapshots persist to database for trend analysis"
  artifacts:
    - path: "src/services/tool-use-quality-analyzer.ts"
      provides: "Tool correctness and sequence validation"
      exports: ["analyzeToolUseQuality", "validateToolSequence", "ToolUseQualityReport"]
    - path: "src/db/schema/decision-quality.ts"
      provides: "Quality snapshots table schema"
      exports: ["decisionQualitySnapshots"]
  key_links:
    - from: "src/services/tool-use-quality-analyzer.ts"
      to: "tradeJustifications.toolTrace"
      via: "database query"
      pattern: "tradeJustifications.*toolTrace"
---

<objective>
Create the tool use quality analyzer service and decision quality database schema.

Purpose: Add missing metrics for tool correctness and argument quality that existing services don't track. The existing codebase has confidence calibration, reasoning integrity, and accountability tracking, but NOT tool sequence validation. This fills a critical gap identified in research.

Output: New service that analyzes whether agents use tools correctly (get_portfolio first, prices before trading, thesis updates on buy/sell), plus database schema for storing periodic quality snapshots.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-agent-decision-quality/10-RESEARCH.md

# Existing patterns to follow
@src/services/confidence-calibration-analyzer.ts
@src/db/schema/trade-reasoning.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create decision quality database schema</name>
  <files>src/db/schema/decision-quality.ts, src/db/schema/index.ts</files>
  <action>
Create `src/db/schema/decision-quality.ts` with a `decisionQualitySnapshots` table:
- `id`: text primary key (format: `quality_{agentId}_{timestamp}`)
- `agentId`: text FK to agents.id, not null
- `snapshotAt`: timestamp, not null
- `compositeScore`: real (0-1 scale)
- `calibrationEce`: real (ECE score from calibration analyzer)
- `integrityScore`: real (from reasoning integrity engine)
- `accountabilityScore`: real (from accountability tracker)
- `memoryScore`: real (from cross-session memory analyzer)
- `toolUseScore`: real (from new tool-use-quality-analyzer)
- `toolSequenceViolations`: jsonb array of violation strings
- `grade`: text (A+ through F)
- Index on `agentId` + `snapshotAt` for efficient queries

Export from `src/db/schema/index.ts`.

Follow existing pattern from `llm-usage.ts` for schema structure.
  </action>
  <verify>
`npx tsc --noEmit` passes with no errors in new schema file.
grep "decisionQualitySnapshots" src/db/schema/index.ts returns export.
  </verify>
  <done>Schema file exists with all fields, exported from index, TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Create tool use quality analyzer service</name>
  <files>src/services/tool-use-quality-analyzer.ts</files>
  <action>
Create `src/services/tool-use-quality-analyzer.ts` implementing:

**Interfaces:**
```typescript
interface ToolUseQualityReport {
  agentId: string;
  totalToolCalls: number;
  correctnessScore: number;      // 0-1: proper tool use
  argumentQuality: number;       // 0-1: correct input parameters
  sequenceAdherence: number;     // 0-1: followed required order
  redundantCalls: number;        // unnecessary repeated calls
  violations: ToolSequenceViolation[];
  grade: string;                 // A+ through F
  analyzedAt: string;
}

interface ToolSequenceViolation {
  type: "missing_portfolio" | "missing_theses" | "trade_without_prices" | "buy_without_thesis" | "sell_without_close_thesis" | "redundant_call";
  description: string;
  severity: "low" | "medium" | "high";
}
```

**Functions:**
1. `analyzeToolUseQuality(agentId: string, lookbackHours?: number): Promise<ToolUseQualityReport>`
   - Query tradeJustifications for agent's recent tool traces
   - Run validateToolSequence on each trace
   - Aggregate into report with scores

2. `validateToolSequence(toolTrace: ToolCall[]): { valid: boolean; violations: ToolSequenceViolation[] }`
   - Check: get_portfolio should be first call
   - Check: get_active_theses should be early (first 3 calls)
   - Check: get_stock_prices called before any buy/sell action
   - Check: update_thesis called if action is buy
   - Check: close_thesis called if action is sell
   - Check: no redundant consecutive identical calls

3. `computeToolUseGrade(score: number): string`
   - Use same thresholds as research: A+ >= 0.95, A >= 0.90, etc.

**Key patterns:**
- Query db for `tradeJustifications` with `toolTrace` jsonb field
- toolTrace is array of `{ turn, tool, arguments, result, timestamp }`
- Follow in-memory cache pattern from `confidence-calibration-analyzer.ts`
- Use existing trade-reasoning schema types
  </action>
  <verify>
`npx tsc --noEmit` passes with no errors.
Service file exists with all exported functions.
  </verify>
  <done>Service exports analyzeToolUseQuality, validateToolSequence, ToolUseQualityReport. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - zero TypeScript errors
2. `grep -r "tool-use-quality" src/` shows new service
3. `grep "decisionQualitySnapshots" src/db/schema/index.ts` shows export
4. Service can be imported: add test import in a scratch file
</verification>

<success_criteria>
- New service file exists at src/services/tool-use-quality-analyzer.ts
- New schema file exists at src/db/schema/decision-quality.ts
- Schema exported from src/db/schema/index.ts
- All exports: analyzeToolUseQuality, validateToolSequence, ToolUseQualityReport, decisionQualitySnapshots
- TypeScript compilation: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-agent-decision-quality/10-01-SUMMARY.md`
</output>

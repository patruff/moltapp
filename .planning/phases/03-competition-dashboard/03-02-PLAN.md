---
phase: 03-competition-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/routes/pages.tsx
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Browsing to / shows a ranked leaderboard table of agents sorted by P&L percentage"
    - "Leaderboard shows columns: rank, agent name + karma, portfolio value, P&L %, trades, last trade time"
    - "Positive P&L values are green, negative P&L values are red"
    - "Clicking an agent name navigates to /agent/:id showing a minimal stats card"
    - "Agent profile card shows: name, karma, rank, portfolio value, P&L, trade count"
    - "Pages are publicly accessible without authentication"
    - "Pages auto-refresh every 30 minutes"
    - "Layout is mobile-responsive with a dark financial terminal aesthetic"
  artifacts:
    - path: "src/routes/pages.tsx"
      provides: "Public web page routes for leaderboard and agent profile"
      exports: ["pageRoutes"]
    - path: "src/index.ts"
      provides: "Public page route mounting before auth middleware"
      contains: "pageRoutes"
  key_links:
    - from: "src/routes/pages.tsx"
      to: "src/services/leaderboard.ts"
      via: "getLeaderboard() import for data"
      pattern: "getLeaderboard"
    - from: "src/index.ts"
      to: "src/routes/pages.tsx"
      via: "app.route import and mounting"
      pattern: 'app\\.route.*pageRoutes'
    - from: "src/routes/pages.tsx"
      to: "/"
      via: "GET / handler renders leaderboard HTML"
      pattern: 'pages\\.get.*"/"'
    - from: "src/routes/pages.tsx"
      to: "/agent/:id"
      via: "GET /agent/:id handler renders profile card HTML"
      pattern: 'pages\\.get.*"/agent/:id"'
---

<objective>
Build the public web pages: leaderboard table and agent profile stats card, served as Hono JSX server-rendered HTML with Tailwind CSS v4 CDN styling.

Purpose: This is the human-facing competition dashboard -- the core deliverable of Phase 3. Spectators visit the leaderboard to see which AI agents are winning, and click through to individual agent stats cards. These pages consume the leaderboard service built in Plan 01.

Output: Two public web pages (`/` for leaderboard, `/agent/:id` for profile) with a dark financial terminal aesthetic, mobile-responsive layout, and 30-minute auto-refresh.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-competition-dashboard/03-CONTEXT.md
@.planning/phases/03-competition-dashboard/03-RESEARCH.md
@.planning/phases/03-competition-dashboard/03-01-SUMMARY.md

Key source files:
@src/services/leaderboard.ts    -- getLeaderboard(), LeaderboardEntry, LeaderboardData types (from Plan 01)
@src/index.ts                   -- current route mounting order (add public pages BEFORE auth middleware)
@tsconfig.json                  -- must have jsx/jsxImportSource from Plan 01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Public web pages -- leaderboard and agent profile</name>
  <files>src/routes/pages.tsx</files>
  <action>
    Create `src/routes/pages.tsx` with the leaderboard page and agent profile page. This single file contains the layout, both pages, and the route handlers.

    **File structure overview:**
    1. Imports and type augmentation
    2. jsxRenderer layout middleware
    3. GET `/` -- leaderboard page
    4. GET `/agent/:id` -- agent profile stats card
    5. Export

    **Step 1 -- Imports and type augmentation:**

    ```tsx
    import { Hono } from "hono";
    import { jsxRenderer } from "hono/jsx-renderer";
    import { getLeaderboard } from "../services/leaderboard.ts";
    import type { LeaderboardEntry } from "../services/leaderboard.ts";

    // Type-safe c.render() with title prop
    declare module "hono" {
      interface ContextRenderer {
        (
          content: string | Promise<string>,
          props: { title: string }
        ): Response;
      }
    }

    const pages = new Hono();
    ```

    **Step 2 -- Layout middleware using jsxRenderer:**

    Apply `jsxRenderer` to all page routes with `pages.use("*", jsxRenderer(...))`.

    The layout renders:
    - `<!DOCTYPE html>` (handled automatically by jsxRenderer)
    - `<html lang="en" class="dark">`
    - `<head>` with:
      - `<meta charset="UTF-8" />`
      - `<meta name="viewport" content="width=device-width, initial-scale=1.0" />`
      - `<title>` from props
      - Tailwind v4 CDN: `<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>`
      - Custom theme in `<style type="text/tailwindcss">` block:
        ```
        @theme {
          --color-profit: #22c55e;
          --color-loss: #ef4444;
        }
        ```
      - Auto-refresh: `<meta http-equiv="refresh" content="1800" />` (30 minutes)
    - `<body class="bg-gray-950 text-gray-100 min-h-screen font-mono">`
    - `{children}` (page content)

    **Step 3 -- GET `/` leaderboard page:**

    Handler calls `const data = await getLeaderboard()` then renders via `c.render(...)`.

    Page structure:
    - **Header section** (`<header>` with margin-bottom):
      - `<h1>` "MoltApp" in bold, large text
      - `<p>` tagline "AI agents trading real stocks" in muted text
      - **Aggregate stats row** (flex, gap): "{data.aggregateStats.totalAgents} agents competing" and "Total volume: ${data.aggregateStats.totalVolume}"

    - **Leaderboard table** (full-width, text-sm):
      - `<thead>` with columns: `#`, `Agent`, `Portfolio Value` (right-aligned), `P&L %` (right-aligned), `Trades` (right-aligned), `Last Trade` (right-aligned, hidden on mobile via `hidden sm:table-cell`)
      - Header row has bottom border `border-b border-gray-800`, text is `text-gray-400`
      - `<tbody>` maps over `data.entries` (first 50 by default). Each row (`<tr>`):
        - Bottom border `border-b border-gray-800/50`, hover highlight `hover:bg-gray-900/50`
        - Rank column: `{entry.rank}`
        - Agent column: `<a href={"/agent/" + entry.agentId}>` with `hover:underline text-gray-100` showing `entry.agentName`. If `entry.karma > 0`, append a karma badge: `<span class="ml-1.5 text-yellow-500 text-xs">` showing the karma number with a star or similar indicator
        - Portfolio value: right-aligned, `font-mono`, formatted as `$` prefix + `entry.totalPortfolioValue`
        - P&L %: right-aligned, `font-mono`. Color-coded: if parseFloat(entry.totalPnlPercent) >= 0, use `text-profit` class, else `text-loss`. Prefix with `+` for positive values. Display as `{value}%`
        - Trades: right-aligned, `entry.tradeCount`
        - Last trade: right-aligned, `text-gray-500`, `hidden sm:table-cell`. If `entry.lastTradeAt` is non-null, format as a short date/time. If null, show `"-"`

    - **"Show more" implementation:** Initially render ALL entries in the tbody but wrap entries after index 49 (50th onward) in rows with a CSS class `class="hidden"` and a data attribute `data-extra="true"`. Below the table, add a button:
      ```html
      <button id="show-more-btn" class="..." onclick="document.querySelectorAll('[data-extra]').forEach(r => r.classList.remove('hidden')); this.remove()">
        Show all {data.entries.length} agents
      </button>
      ```
      Only show this button if `data.entries.length > 50`. Use inline onclick -- no external JS files.

    - **Footer** (below table): "Updated: {data.computedAt.toISOString()}" in `text-xs text-gray-600`.

    Use `{ title: "MoltApp Leaderboard" }` as the second argument to `c.render()`.

    **Step 4 -- GET `/agent/:id` agent profile stats card:**

    Handler:
    1. Extract `id` from `c.req.param("id")`
    2. Call `const data = await getLeaderboard()`
    3. Find entry: `data.entries.find(e => e.agentId === id)`
    4. If not found, return a simple "Agent not found" page via `c.render(...)` with a link back to `/`
    5. If found, render the stats card

    **Stats card design (minimal, per CONTEXT.md):**
    - Centered card with max-width (~md), some padding, subtle border `border border-gray-800`, rounded corners `rounded-lg`, dark background `bg-gray-900`
    - **Agent name** as `<h1>` (large, bold) with karma badge beside it (same style as leaderboard)
    - **Rank badge**: "Rank #{entry.rank}" in a colored badge/pill
    - **Stats grid** (2 columns on mobile, adapts): Each stat as a labeled value pair:
      - "Portfolio Value" -> `$entry.totalPortfolioValue`
      - "Total P&L" -> `$entry.totalPnlAbsolute` with color coding (profit/loss) and percentage in parentheses
      - "Trades" -> `entry.tradeCount`
      - "Last Trade" -> formatted date or "No trades yet"
    - **Back link** at bottom: `<a href="/">` "Back to Leaderboard" styled as a subtle link

    Use `{ title: entry.agentName + " | MoltApp" }` as the render props.

    **Styling approach:**
    - Dark theme: bg-gray-950 body, bg-gray-900 cards, border-gray-800 borders
    - Financial terminal feel: font-mono for numbers, data-dense table, minimal decoration
    - Mobile responsive: table columns hide on small screens (Last Trade hides), stats card stacks vertically
    - Green (#22c55e / text-profit) for positive P&L, red (#ef4444 / text-loss) for negative
    - All Tailwind utility classes inline -- NO `@apply` (not supported by CDN)

    **Date formatting:** Use `toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })` for last trade timestamps. This runs server-side so use a consistent locale.

    **Export:**
    ```tsx
    export { pages as pageRoutes };
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` -- should compile with zero TypeScript errors. Verify `src/routes/pages.tsx` exports `pageRoutes`. Verify it has both GET `/` and GET `/agent/:id` handlers. Verify it imports `getLeaderboard` from the leaderboard service. Verify the file uses `.tsx` extension (not `.ts`).
  </verify>
  <done>
    `src/routes/pages.tsx` renders a public leaderboard at `/` with ranked table (rank, name+karma, portfolio value, P&L %, trades, last trade) and agent profile at `/agent/:id` with a minimal stats card. Dark financial terminal theme with green/red P&L coloring. Mobile-responsive. Auto-refreshes every 30 minutes via meta refresh tag. Top 50 shown by default with "Show more" button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount public page routes in index.ts</name>
  <files>src/index.ts</files>
  <action>
    **src/index.ts:** Mount the public page routes BEFORE the auth middleware so they are accessible without API keys.

    Add import at top (alongside existing imports):
    ```typescript
    import { pageRoutes } from "./routes/pages.tsx";
    ```

    NOTE: The import path uses `.tsx` extension. This works because:
    - `tsx` (the dev runner) resolves it directly
    - `tsc` with `rewriteRelativeImportExtensions: true` will rewrite `.tsx` to `.js` in output
    - The existing codebase already uses `.ts` extensions in imports for the same reason

    Add the route mount AFTER the health check and BEFORE the auth routes. Insert it between the health check block and the auth routes block:

    ```typescript
    // Health check (public)
    app.get("/health", (c) => {
      return c.json({ status: "ok" });
    });

    // Public web pages (no auth -- leaderboard and agent profiles)
    app.route("/", pageRoutes);

    // Auth routes (public -- registration is unauthenticated)
    app.route("/api/v1/auth", authRoutes);
    ```

    This placement ensures:
    1. Public pages at `/` and `/agent/:id` are NOT behind auth middleware
    2. The `/api/v1/*` auth middleware (registered later) does NOT intercept page routes
    3. The leaderboard JSON API at `/api/v1/leaderboard` (mounted by Plan 01 AFTER auth) IS protected

    **CRITICAL ordering verification:** After editing, the route registration order in index.ts must be:
    1. `/health` (public)
    2. `/` pageRoutes (public -- NEW)
    3. `/api/v1/auth` (public)
    4. `/webhooks` (public, own auth)
    5. `/api/v1/*` auth middleware + rate limiter
    6. `/api/v1/wallet` (protected)
    7. `/api/v1/stocks` (protected)
    8. `/api/v1/trading` (protected)
    9. `/api/v1/positions` (protected)
    10. `/api/v1/trades` (protected)
    11. `/api/v1/leaderboard` (protected -- from Plan 01)
    12. `/api/v1/me` (protected placeholder)

    **CRITICAL:** Keep `src/index.ts` as a `.ts` file. It does NOT contain JSX syntax -- only imports. The `.tsx` import path is valid in `.ts` files.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- should compile with zero TypeScript errors. Verify `src/index.ts` imports `pageRoutes` from `"./routes/pages.tsx"`. Verify the `app.route("/", pageRoutes)` line appears BEFORE the `app.use("/api/v1/*", authMiddleware, agentRateLimiter)` line.
  </verify>
  <done>
    Public page routes mounted at `/` before auth middleware. Browsing to `/` serves the leaderboard HTML. Browsing to `/agent/:id` serves the agent profile card. No authentication required for either page. All existing protected API routes unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles with zero TypeScript errors
2. `src/routes/pages.tsx` exists and exports `pageRoutes`
3. Leaderboard page renders at GET `/` with ranked table showing all required columns
4. Agent profile page renders at GET `/agent/:id` with stats card
5. P&L values are color-coded: green for positive (text-profit), red for negative (text-loss)
6. Pages use Tailwind v4 CDN (script tag in head)
7. Meta refresh tag set to 1800 seconds (30 minutes)
8. `src/index.ts` mounts pageRoutes BEFORE auth middleware
9. `src/index.ts` remains `.ts` (not renamed to `.tsx`)
10. Agent links on leaderboard point to `/agent/{agentId}`
11. "Show more" button appears when more than 50 agents exist
12. Layout is mobile-responsive (Last Trade column hidden on small screens)
</verification>

<success_criteria>
- Public leaderboard at `/` shows agents ranked by P&L % with all specified columns
- Agent profile at `/agent/:id` shows minimal stats card (name, karma, rank, value, P&L, trades)
- Dark financial terminal aesthetic with font-mono, data-dense layout
- Green/red P&L color coding using custom Tailwind theme colors
- Mobile-responsive with column hiding on small screens
- Auto-refreshes every 30 minutes via meta refresh
- No authentication required to view pages
- Existing API routes unaffected by new page route mounting
</success_criteria>

<output>
After completion, create `.planning/phases/03-competition-dashboard/03-02-SUMMARY.md`
</output>

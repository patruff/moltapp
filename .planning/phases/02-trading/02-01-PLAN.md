---
phase: 02-trading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/positions.ts
  - src/db/schema/trades.ts
  - src/db/schema/index.ts
  - src/config/constants.ts
  - src/config/env.ts
autonomous: true

must_haves:
  truths:
    - "positions and trades tables exist in the schema and can be imported"
    - "xStocks catalog is available as a typed constant array"
    - "JUPITER_API_KEY is validated at startup"
    - "Token-2022 program address is available as a constant"
  artifacts:
    - path: "src/db/schema/positions.ts"
      provides: "positions table schema with agentId FK, mintAddress, symbol, quantity, averageCostBasis, unique(agentId, mintAddress)"
      contains: "pgTable"
    - path: "src/db/schema/trades.ts"
      provides: "trades table schema with agentId FK, side, stockMintAddress, stockSymbol, stockQuantity, usdcAmount, pricePerToken, txSignature unique, jupiterRouteInfo jsonb, status"
      contains: "pgTable"
    - path: "src/db/schema/index.ts"
      provides: "re-exports positions and trades alongside existing schemas"
      exports: ["positions", "trades"]
    - path: "src/config/constants.ts"
      provides: "xStocks catalog array, Token-2022 program address, Jupiter API base URL, ATA program address"
      contains: "XSTOCKS_CATALOG"
    - path: "src/config/env.ts"
      provides: "JUPITER_API_KEY as required env var"
      contains: "JUPITER_API_KEY"
  key_links:
    - from: "src/db/schema/positions.ts"
      to: "src/db/schema/agents.ts"
      via: "FK reference agents.id"
      pattern: "references.*agents\\.id"
    - from: "src/db/schema/trades.ts"
      to: "src/db/schema/agents.ts"
      via: "FK reference agents.id"
      pattern: "references.*agents\\.id"
    - from: "src/db/schema/index.ts"
      to: "src/db/schema/positions.ts"
      via: "re-export"
      pattern: "export.*positions"
---

<objective>
Create the database schema and configuration foundation for Phase 2 trading.

Purpose: All trading services and routes depend on the positions/trades tables and the xStocks token catalog. This plan establishes the data layer and constants so Plan 02 can build services and routes on top.

Output: Two new DB schema files (positions, trades), updated schema index, expanded constants (xStocks catalog + Token-2022 address), and JUPITER_API_KEY env validation.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-trading/02-CONTEXT.md
@.planning/phases/02-trading/02-RESEARCH.md
@src/db/schema/index.ts
@src/db/schema/transactions.ts
@src/db/schema/agents.ts
@src/config/constants.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema for positions and trades tables</name>
  <files>src/db/schema/positions.ts, src/db/schema/trades.ts, src/db/schema/index.ts</files>
  <action>
Create `src/db/schema/positions.ts`:
- Import from `drizzle-orm/pg-core`: pgTable, text, integer, numeric, timestamp, unique
- Import `agents` from `./agents.ts` (use .ts extension per project convention)
- Define `positions` table with columns:
  - `id`: integer PK, generatedAlwaysAsIdentity (matches Phase 1 pattern from transactions.ts)
  - `agentId`: text, FK to agents.id, notNull
  - `mintAddress`: text, notNull (xStocks token mint address)
  - `symbol`: text, notNull (e.g., "AAPLx")
  - `quantity`: numeric(20, 9), notNull (token amount, 9 decimals for precision)
  - `averageCostBasis`: numeric(20, 6), notNull (USDC per token, 6 decimals)
  - `createdAt`: timestamp, defaultNow, notNull
  - `updatedAt`: timestamp, defaultNow, notNull
- Add unique constraint on (agentId, mintAddress) -- one position per agent per stock
- Export `positions`

Create `src/db/schema/trades.ts`:
- Import from `drizzle-orm/pg-core`: pgTable, text, integer, numeric, timestamp, jsonb
- Import `agents` from `./agents.ts`
- Define `trades` table with columns:
  - `id`: integer PK, generatedAlwaysAsIdentity
  - `agentId`: text, FK to agents.id, notNull
  - `side`: text, notNull (values: 'buy' or 'sell')
  - `stockMintAddress`: text, notNull
  - `stockSymbol`: text, notNull
  - `stockQuantity`: numeric(20, 9), notNull (tokens received/sold)
  - `usdcAmount`: numeric(20, 6), notNull (USDC spent/received)
  - `pricePerToken`: numeric(20, 6), notNull (execution price)
  - `txSignature`: text, notNull, unique (Solana tx signature, idempotency key)
  - `jupiterRouteInfo`: jsonb, nullable (route details for debugging)
  - `status`: text, notNull, default 'confirmed' (values: 'confirmed' or 'failed')
  - `createdAt`: timestamp, defaultNow, notNull
- Export `trades`

Update `src/db/schema/index.ts`:
- Add two new re-exports: `export { positions } from "./positions.ts";` and `export { trades } from "./trades.ts";`
- Keep all existing exports (agents, wallets, apiKeys, transactions)

Run `npx drizzle-kit generate` to generate the migration files.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the generated migration SQL in `src/db/migrations/` contains CREATE TABLE for both positions and trades with correct columns and constraints.
  </verify>
  <done>positions and trades tables defined in schema, re-exported from index.ts, migration SQL generated. Both tables have agentId FK, correct column types, and unique constraints (agentId+mintAddress for positions, txSignature for trades).</done>
</task>

<task type="auto">
  <name>Task 2: xStocks catalog, Token-2022 constants, and Jupiter env var</name>
  <files>src/config/constants.ts, src/config/env.ts</files>
  <action>
Update `src/config/constants.ts` -- add the following BELOW existing constants (do NOT remove existing USDC_MINT, API_KEY_PREFIX, or RATE_LIMIT constants):

1. Add Jupiter API base URL:
```typescript
/** Jupiter API base URL (all endpoints) */
export const JUPITER_API_BASE_URL = "https://api.jup.ag";
```

2. Add Token-2022 program address:
```typescript
/** Token-2022 (Token Extensions) program address -- used by xStocks tokens */
export const TOKEN_2022_PROGRAM_ADDRESS = "TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb";
```

3. Add ATA program address (shared constant, currently duplicated in withdrawal.ts and wallets.ts):
```typescript
/** Associated Token Account program address */
export const ATA_PROGRAM_ADDRESS = "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL";
```

4. Add StockToken interface and the curated xStocks catalog with all 20 top-traded tokens from the research (the full 76 can be expanded later):
```typescript
export interface StockToken {
  symbol: string;
  name: string;
  mintAddress: string;
  decimals: number; // Assumed 9 for all xStocks; must verify on-chain before production use
}

export const XSTOCKS_CATALOG: StockToken[] = [
  { symbol: "AAPLx", name: "Apple", mintAddress: "XsbEhLAtcf6HdfpFZ5xEMdqW8nfAvcsP5bdudRLJzJp", decimals: 9 },
  { symbol: "AMZNx", name: "Amazon", mintAddress: "Xs3eBt7uRfJX8QUs4suhyU8p2M6DoUDrJyWBa8LLZsg", decimals: 9 },
  { symbol: "GOOGLx", name: "Alphabet", mintAddress: "XsCPL9dNWBMvFtTmwcCA5v3xWPSMEBCszbQdiLLq6aN", decimals: 9 },
  { symbol: "METAx", name: "Meta", mintAddress: "Xsa62P5mvPszXL1krVUnU5ar38bBSVcWAB6fmPCo5Zu", decimals: 9 },
  { symbol: "MSFTx", name: "Microsoft", mintAddress: "XspzcW1PRtgf6Wj92HCiZdjzKCyFekVD8P5Ueh3dRMX", decimals: 9 },
  { symbol: "NVDAx", name: "NVIDIA", mintAddress: "Xsc9qvGR1efVDFGLrVsmkzv3qi45LTBjeUKSPmx9qEh", decimals: 9 },
  { symbol: "TSLAx", name: "Tesla", mintAddress: "XsDoVfqeBukxuZHWhdvWHBhgEHjGNst4MLodqsJHzoB", decimals: 9 },
  { symbol: "SPYx", name: "S&P 500 ETF", mintAddress: "XsoCS1TfEyfFhfvj8EtZ528L3CaKBDBRqRapnBbDF2W", decimals: 9 },
  { symbol: "QQQx", name: "Nasdaq 100 ETF", mintAddress: "Xs8S1uUs1zvS2p7iwtsG3b6fkhpvmwz4GYU3gWAmWHZ", decimals: 9 },
  { symbol: "COINx", name: "Coinbase", mintAddress: "Xs7ZdzSHLU9ftNJsii5fCeJhoRWSC32SQGzGQtePxNu", decimals: 9 },
  { symbol: "CRCLx", name: "Circle", mintAddress: "XsueG8BtpquVJX9LVLLEGuViXUungE6WmK5YZ3p3bd1", decimals: 9 },
  { symbol: "MSTRx", name: "MicroStrategy", mintAddress: "XsP7xzNPvEHS1m6qfanPUGjNmdnmsLKEoNAnHjdxxyZ", decimals: 9 },
  { symbol: "AVGOx", name: "Broadcom", mintAddress: "XsgSaSvNSqLTtFuyWPBhK9196Xb9Bbdyjj4fH3cPJGo", decimals: 9 },
  { symbol: "JPMx", name: "JPMorgan Chase", mintAddress: "XsMAqkcKsUewDrzVkait4e5u4y8REgtyS7jWgCpLV2C", decimals: 9 },
  { symbol: "HOODx", name: "Robinhood", mintAddress: "XsvNBAYkrDRNhA7wPHQfX3ZUXZyZLdnCQDfHZ56bzpg", decimals: 9 },
  { symbol: "LLYx", name: "Eli Lilly", mintAddress: "Xsnuv4omNoHozR6EEW5mXkw8Nrny5rB3jVfLqi6gKMH", decimals: 9 },
  { symbol: "CRMx", name: "Salesforce", mintAddress: "XsczbcQ3zfcgAEt9qHQES8pxKAVG5rujPSHQEXi4kaN", decimals: 9 },
  { symbol: "NFLXx", name: "Netflix", mintAddress: "XsEH7wWfJJu2ZT3UCFeVfALnVA6CP5ur7Ee11KmzVpL", decimals: 9 },
  { symbol: "PLTRx", name: "Palantir", mintAddress: "XsoBhf2ufR8fTyNSjqfU71DYGaE6Z3SUGAidpzriAA4", decimals: 9 },
  { symbol: "GMEx", name: "GameStop", mintAddress: "Xsf9mBktVB9BSU5kf4nHxPq5hCBJ2j2ui3ecFGxPRGc", decimals: 9 },
];
```

Update `src/config/env.ts`:
- Add `JUPITER_API_KEY: z.string().min(1, "JUPITER_API_KEY is required")` to the envSchema object, in the "Required" section after MOLTBOOK_APP_KEY.
- This is REQUIRED (not optional) because all Jupiter API calls need it. The app cannot function for Phase 2 without it.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify that importing `{ XSTOCKS_CATALOG, JUPITER_API_BASE_URL, TOKEN_2022_PROGRAM_ADDRESS, StockToken }` from constants.ts works. Verify that env.ts requires JUPITER_API_KEY (will fail at startup if missing, which is correct).
  </verify>
  <done>constants.ts exports XSTOCKS_CATALOG (20 tokens with symbol, name, mintAddress, decimals), JUPITER_API_BASE_URL, TOKEN_2022_PROGRAM_ADDRESS, ATA_PROGRAM_ADDRESS, and StockToken interface. env.ts requires JUPITER_API_KEY at startup.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx drizzle-kit generate` produces migration SQL for positions and trades tables
3. All existing code still compiles (no breaking changes to constants.ts or env.ts)
4. The schema index re-exports all 6 schemas: agents, wallets, apiKeys, transactions, positions, trades
</verification>

<success_criteria>
- positions table: agentId FK, mintAddress, symbol, quantity(20,9), averageCostBasis(20,6), unique(agentId, mintAddress)
- trades table: agentId FK, side, stockMintAddress, stockSymbol, stockQuantity(20,9), usdcAmount(20,6), pricePerToken(20,6), txSignature unique, jupiterRouteInfo jsonb, status default 'confirmed'
- XSTOCKS_CATALOG: 20 tokens with verified mint addresses from research
- JUPITER_API_KEY: required in env validation
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-trading/02-01-SUMMARY.md`
</output>

---
phase: 04-aws-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/package.json
  - infra/tsconfig.json
  - infra/cdk.json
  - infra/bin/app.ts
  - infra/lib/moltapp-stack.ts
autonomous: true

must_haves:
  truths:
    - "`cdk synth` produces a valid CloudFormation template with Lambda, API Gateway, CloudFront, Secrets Manager, Route53, and ACM resources"
    - "Lambda function is configured with ARM64 architecture, 1024 MB memory, 30s timeout, Node.js 22 runtime"
    - "Lambda bundling uses ESM format with createRequire banner, minify, source maps, and tsconfig reference for JSX"
    - "CloudFront distribution has caching disabled and forwards all viewer headers except Host"
    - "Secrets Manager secret ARN is passed to Lambda as SECRET_ARN environment variable (not actual secret values)"
    - "Route53 A record aliases patgpt.us to the CloudFront distribution"
  artifacts:
    - path: "infra/package.json"
      provides: "CDK project dependencies (aws-cdk-lib, constructs, aws-cdk, typescript)"
    - path: "infra/tsconfig.json"
      provides: "TypeScript config for CDK project"
    - path: "infra/cdk.json"
      provides: "CDK app configuration pointing to bin/app.ts"
    - path: "infra/bin/app.ts"
      provides: "CDK app entry point instantiating MoltappStack"
    - path: "infra/lib/moltapp-stack.ts"
      provides: "Single CDK stack with all AWS resources"
      contains: "MoltappStack"
  key_links:
    - from: "infra/lib/moltapp-stack.ts"
      to: "../src/lambda.ts"
      via: "NodejsFunction entry property"
      pattern: "entry.*lambda\\.ts"
    - from: "infra/lib/moltapp-stack.ts"
      to: "Secrets Manager"
      via: "secret.grantRead(fn) and SECRET_ARN env var"
      pattern: "secret\\.grantRead"
    - from: "infra/lib/moltapp-stack.ts"
      to: "CloudFront"
      via: "HttpOrigin pointing to API Gateway execute URL"
      pattern: "HttpOrigin"
---

<objective>
Create the AWS CDK infrastructure-as-code project in `infra/` with a single stack defining all production resources: Lambda function (pointing at the app's lambda.ts entry), API Gateway HTTP API, CloudFront distribution with custom domain, Secrets Manager, Route53 + ACM certificate.

Purpose: This is the infrastructure-side half of the deployment story. Running `cdk deploy` from the `infra/` directory creates all AWS resources from scratch. Combined with Plan 01's Lambda-ready app code, this makes the full production deployment possible.

Output: 5 new files in `infra/` directory with CDK project and stack definition.
</objective>

<execution_context>
@/Users/patruff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patruff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-aws-deployment/04-RESEARCH.md
@.planning/phases/04-aws-deployment/04-CONTEXT.md

@tsconfig.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize CDK project in infra/</name>
  <files>infra/package.json, infra/tsconfig.json, infra/cdk.json, infra/bin/app.ts</files>
  <action>
1. Create `infra/` directory structure:
   ```
   infra/
   ├── bin/
   │   └── app.ts
   ├── lib/
   │   └── (moltapp-stack.ts created in Task 2)
   ├── package.json
   ├── tsconfig.json
   └── cdk.json
   ```

2. Create `infra/package.json`:
   ```json
   {
     "name": "moltapp-infra",
     "version": "1.0.0",
     "type": "module",
     "scripts": {
       "cdk": "cdk",
       "synth": "cdk synth",
       "deploy": "cdk deploy",
       "diff": "cdk diff"
     },
     "dependencies": {
       "aws-cdk-lib": "^2.170.0",
       "constructs": "^10.4.2"
     },
     "devDependencies": {
       "aws-cdk": "^2.170.0",
       "typescript": "^5.9.3"
     }
   }
   ```

3. Create `infra/tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "NodeNext",
       "moduleResolution": "NodeNext",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "forceConsistentCasingInFileNames": true,
       "outDir": "dist",
       "rootDir": ".",
       "declaration": true,
       "sourceMap": true
     },
     "include": ["bin/**/*", "lib/**/*"],
     "exclude": ["node_modules", "dist"]
   }
   ```

4. Create `infra/cdk.json`:
   ```json
   {
     "app": "npx tsx bin/app.ts"
   }
   ```

5. Create `infra/bin/app.ts`:
   ```typescript
   #!/usr/bin/env node
   import * as cdk from "aws-cdk-lib";
   import { MoltappStack } from "../lib/moltapp-stack.ts";

   const app = new cdk.App();
   new MoltappStack(app, "MoltappStack", {
     env: {
       account: process.env.CDK_DEFAULT_ACCOUNT,
       region: "us-east-1",
     },
   });
   ```

6. Run `cd infra && npm install` to install CDK dependencies.
  </action>
  <verify>
Verify `infra/node_modules/aws-cdk-lib` exists. Run `cd infra && npx tsc --noEmit` -- it will fail because moltapp-stack.ts doesn't exist yet, but bin/app.ts itself should have correct CDK imports.
  </verify>
  <done>
CDK project initialized in `infra/` with package.json, tsconfig, cdk.json, and app entry point. Dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MoltappStack with all AWS resources</name>
  <files>infra/lib/moltapp-stack.ts</files>
  <action>
Create `infra/lib/moltapp-stack.ts` with a single CDK stack containing all resources:

**1. Secrets Manager Secret:**
- Create a secret named `moltapp/production` with description "MoltApp production secrets"
- Do NOT set initial secret value in CDK (user populates it manually after first deploy)

**2. Lambda Function (NodejsFunction):**
- Entry: `../src/lambda.ts` (path relative to infra/ directory)
- Handler: `handler`
- Runtime: `NODEJS_22_X`
- Architecture: `ARM_64`
- Memory: 1024 MB
- Timeout: 30 seconds
- Environment variables:
  - `NODE_ENV`: `"production"`
  - `SECRET_ARN`: `secret.secretArn` (reference to the Secrets Manager secret)
- Bundling options:
  - `format`: `OutputFormat.ESM`
  - `target`: `"node22"`
  - `mainFields`: `["module", "main"]`
  - `banner`: `"import{createRequire}from'module';const require=createRequire(import.meta.url);"`
  - `minify`: `true`
  - `sourceMap`: `true`
  - `tsconfig`: `"../tsconfig.json"` (the app tsconfig, for JSX support)
  - `externalModules`: `[]` (bundle everything, no node_modules in Lambda)
- Grant the Lambda function read access to the secret: `secret.grantRead(fn)`

**3. API Gateway HTTP API:**
- Create `HttpApi` with description "MoltApp API"
- Add a catch-all route: `/{proxy+}` with `ANY` method
- Integration: `HttpLambdaIntegration` pointing to the Lambda function
- Also add a root route for `/` with `ANY` method (HttpApi's `/{proxy+}` does NOT match the root path)

**4. Route53 + ACM Certificate:**
- Look up existing hosted zone for `patgpt.us` using `HostedZone.fromLookup()`
- Create ACM certificate for `patgpt.us` with DNS validation via the hosted zone

**5. CloudFront Distribution:**
- Origin: `HttpOrigin` pointing to `${httpApi.httpApiId}.execute-api.${this.region}.amazonaws.com`
- Domain names: `["patgpt.us"]`
- Certificate: the ACM certificate created above
- Default behavior:
  - `viewerProtocolPolicy`: `REDIRECT_TO_HTTPS`
  - `allowedMethods`: `ALLOW_ALL` (GET, HEAD, OPTIONS, PUT, PATCH, POST, DELETE)
  - `cachePolicy`: `CACHING_DISABLED`
  - `originRequestPolicy`: `ALL_VIEWER_EXCEPT_HOST_HEADER` (forwards Authorization and all custom headers)

**6. Route53 A Record:**
- Create an A record aliasing `patgpt.us` to the CloudFront distribution using `CloudFrontTarget`

**7. Stack Outputs:**
- Output the CloudFront distribution domain name
- Output the API Gateway URL
- Output the custom domain (patgpt.us)

Import all needed CDK modules at the top of the file:
- `aws-cdk-lib` (core)
- `aws-cdk-lib/aws-lambda` (Runtime, Architecture)
- `aws-cdk-lib/aws-lambda-nodejs` (NodejsFunction, OutputFormat)
- `aws-cdk-lib/aws-apigatewayv2` (HttpApi, HttpMethod)
- `aws-cdk-lib/aws-apigatewayv2-integrations` (HttpLambdaIntegration)
- `aws-cdk-lib/aws-cloudfront` (Distribution, ViewerProtocolPolicy, AllowedMethods, CachePolicy, OriginRequestPolicy)
- `aws-cdk-lib/aws-cloudfront-origins` (HttpOrigin)
- `aws-cdk-lib/aws-secretsmanager` (Secret)
- `aws-cdk-lib/aws-certificatemanager` (Certificate, CertificateValidation)
- `aws-cdk-lib/aws-route53` (HostedZone, ARecord, RecordTarget)
- `aws-cdk-lib/aws-route53-targets` (CloudFrontTarget)
- `constructs` (Construct)
  </action>
  <verify>
Run `cd infra && npx tsc --noEmit` to verify the stack compiles without TypeScript errors. Then run `cd infra && npx cdk synth 2>&1 | head -50` to verify it produces CloudFormation output (it may fail on HostedZone.fromLookup if AWS credentials aren't configured -- that's expected and OK. The important thing is no TypeScript compilation errors).
  </verify>
  <done>
`infra/lib/moltapp-stack.ts` defines a complete CDK stack with Lambda (NodejsFunction + ESM bundling), API Gateway HTTP API, CloudFront with custom domain, Secrets Manager, Route53 + ACM. Running `cdk deploy` from `infra/` will create all resources.
  </done>
</task>

</tasks>

<verification>
1. `cd infra && npx tsc --noEmit` passes (CDK TypeScript compiles)
2. `infra/lib/moltapp-stack.ts` contains: NodejsFunction, HttpApi, Distribution, Secret, Certificate, ARecord
3. Lambda entry points to `../src/lambda.ts`
4. Lambda bundling has ESM format, createRequire banner, tsconfig reference
5. CloudFront has `CACHING_DISABLED` and `ALL_VIEWER_EXCEPT_HOST_HEADER`
6. SECRET_ARN is passed as Lambda env var (not actual secret values)
7. `infra/node_modules` exists (dependencies installed)
</verification>

<success_criteria>
- CDK project compiles and synthesizes a CloudFormation template
- All seven AWS resource types are defined (Lambda, API Gateway, CloudFront, Secrets Manager, ACM, Route53, Route53 alias)
- Lambda function configuration matches research recommendations (ARM64, 1024 MB, 30s, ESM bundling)
- CloudFront does not cache any responses (all dynamic)
- Infrastructure is reproducible: deleting the stack and re-deploying creates identical resources
</success_criteria>

<output>
After completion, create `.planning/phases/04-aws-deployment/04-02-SUMMARY.md`
</output>

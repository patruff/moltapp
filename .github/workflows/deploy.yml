name: MoltApp CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  # ------------------------------------------------------------------
  # Build & Type Check
  # ------------------------------------------------------------------
  build:
    name: Build & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  # ------------------------------------------------------------------
  # Test
  # ------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          MOLTBOOK_APP_KEY: "test-key"
          JUPITER_API_KEY: "test-key"
          ADMIN_PASSWORD: "test-password"
          NODE_ENV: "test"

  # ------------------------------------------------------------------
  # CDK Deploy (main branch only)
  # ------------------------------------------------------------------
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install CDK dependencies
        working-directory: infra
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: CDK Diff
        working-directory: infra
        run: npx cdk diff

      - name: CDK Deploy
        working-directory: infra
        run: npx cdk deploy --require-approval never

      - name: Post-deploy health check
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30
          HEALTH_URL="${{ secrets.APP_URL }}/health"
          echo "Checking health at: $HEALTH_URL"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Warning: Health check returned HTTP $STATUS (may need DNS propagation)"
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://patgpt.us" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
